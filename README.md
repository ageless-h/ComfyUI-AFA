# ComfyUI-AFA (AI For Animation)

ComfyUI-AFA是一个为动画创作者设计的ComfyUI扩展节点集合，提供了一系列强大的AI辅助工具，帮助创作者更高效地完成动画创作流程。

## 功能特点

- **多种API服务集成**：支持多种在线API服务，包括硅基流动、t8等
- **LLM文本生成**：集成大语言模型，用于剧本、角色设定、世界观构建等创作任务
- **VLM视觉分析**：集成视觉语言模型，用于图像分析和描述
- **图像编辑**：支持基于文本提示的图像编辑功能
- **音乐生成**：支持基于文本描述生成音乐，可控制时长和风格
- **2D动画工具**：完整的图层编辑系统，支持文档管理、图层操作和预览功能
- **结构化创作流程**：提供世界观构建、角色档案、救猫咪结构等专业创作模板
- **统一界面**：所有节点采用统一的AFA分类，便于查找和使用

## 安装方法

### 方法1：通过ComfyUI Manager安装

1. 在ComfyUI中安装[ComfyUI Manager](https://github.com/ltdrdata/ComfyUI-Manager)
2. 打开ComfyUI，点击"Manager"标签
3. 在搜索框中输入"ComfyUI-AFA"并安装

### 方法2：手动安装

```bash
cd /path/to/ComfyUI/custom_nodes/
git clone https://github.com/ageless-h/ComfyUI-AFA.git
```

## 配置设置

首次使用前，需要在`config`文件夹中创建以下配置文件：

1. `config.json`：API密钥、基础URL和模型名称配置
2. `system_prompts.json`：系统提示词模板
3. `user_prompts.json`：用户提示词模板

### 快速配置

项目提供了配置文件样例，您可以直接复制并修改：

```bash
# 进入config目录
cd config/

# 复制样例文件并重命名
cp config.json.example config.json
cp system_prompts.json.example system_prompts.json
cp user_prompts.json.example user_prompts.json

# 然后编辑这些文件，填入您的实际配置
```

### 配置文件示例

#### config.json
```json
{
  "api_keys": {
    "服务商名称1": "你的API密钥1",
    "服务商名称2": "你的API密钥2"
  },
  "base_urls": {
    "服务商名称1": "https://api.example1.com/",
    "服务商名称2": "https://api.example2.com/"
  },
  "model_names": {
    "模型别名1": "模型实际名称1",
    "模型别名2": "模型实际名称2"
  }
}
```

#### system_prompts.json
```json
{
  "提示词名称1": "系统提示词内容1",
  "提示词名称2": "系统提示词内容2"
}
```

#### user_prompts.json
```json
{
  "模板名称1": "模板内容1 {参数1} {参数2}",
  "模板名称2": "模板内容2 {参数A} {参数B}"
}
```

### 配置文件安全说明

- **个人配置文件**（`*.json`）已被添加到`.gitignore`中，不会被上传到Git仓库，保护您的API密钥等敏感信息
- **样例文件**（`*.json.example`）会被包含在项目中，为新用户提供配置参考
- 建议定期检查和更新您的API密钥，确保账户安全

## 节点说明

### 配置节点
- **API Key Selector**：选择API密钥
- **Base URL Selector**：选择API基础URL
- **Model Name Selector**：选择模型名称
- **System Prompt Selector**：选择系统提示词

### 用户输入节点
- **用户输入: 世界观构建**：用于创建动画项目的世界观设定
- **用户输入: 角色档案**：用于创建角色档案和设定
- **用户输入: 救猫咪结构**：用于构建故事大纲和结构
- **用户输入: 剧本场景**：用于编写剧本场景
- **用户输入: 分镜设计**：用于设计分镜

### AI服务节点
- **LLM Prompter (All-in-One)**：大语言模型文本生成
- **VLM Prompter (All-in-One)**：视觉语言模型图像分析
- **图像编辑 (Nano-banana)**：基于文本提示的图像编辑
- **Suno音乐生成器**：基于文本描述生成音乐

### 2D动画工具节点

#### 图层IO (AFA2D/图层IO)
- **导入PSD文档**：从PSD文件导入完整的文档结构，支持图层、混合模式、透明度等
  - 支持文件选择器界面，无需手动输入文件路径
  - 自动解析PSD文件中的所有图层信息
  - 保持原始图层结构和属性
  - 可选择是否保持原始尺寸
- **导出PSD文档**：将文档导出为PSD格式文件，保持图层结构
  - 支持完整的图层信息导出
  - 保持图层名称、位置、透明度和混合模式
  - 兼容主流图像编辑软件

#### 图层编辑 (AFA2D/图层编辑)
- **创建空白文档**：创建指定尺寸的空白文档对象
- **创建图层**：创建包含图像、位置、透明度等属性的图层对象
- **添加图层到文档**：将图层添加到文档中，自动分配图层ID
- **删除图层**：从文档中删除指定图层
- **从文档获取图层**：根据图层名或ID从文档中提取单个图层
- **从文档获取图层列表**：获取文档中所有图层的列表
- **解包图层**：将图层对象分解为各个属性（图像、名称、位置等）
- **更新图层**：修改图层的属性（图像、位置、透明度、混合模式等）
- **获取文档信息**：显示文档的画布尺寸、图层数量等信息
- **获取图层信息**：显示图层的详细属性信息

#### 图层工具 (AFA2D/图层工具)
- **预览文档**：渲染整个文档或指定图层的最终效果
- **预览图层**：预览单个图层的效果

#### 支持的混合模式
- 正常 (normal)、正片叠底 (multiply)、滤色 (screen)
- 叠加 (overlay)、柔光 (soft_light)、强光 (hard_light)
- 颜色减淡 (color_dodge)、颜色加深 (color_burn)
- 变暗 (darken)、变亮 (lighten)、差值 (difference)、排除 (exclusion)

## 使用示例

### 世界观构建工作流
1. 使用**API Key Selector**、**Base URL Selector**和**Model Name Selector**配置API
2. 使用**System Prompt Selector**选择"世界观构建大师"系统提示词
3. 使用**用户输入: 世界观构建**输入项目名称、动画类型等信息
4. 连接到**LLM Prompter**节点生成世界观设定

### 图像编辑工作流
1. 使用**API Key Selector**、**Base URL Selector**和**Model Name Selector**配置API
2. 使用**LoadImage**节点加载需要编辑的图像
3. 使用**图像编辑**节点，输入编辑指令
4. 连接到**PreviewImage**节点查看结果

### 音乐生成工作流
1. 使用**API Key Selector**选择"t8"
2. 使用**Base URL Selector**选择"t8"
3. 使用**Model Name Selector**选择"t8-suno-music"
4. 使用**Suno音乐生成器**节点，输入歌曲标题、描述和标签
5. 设置最大音频时长（10-180秒）
6. 连接到**PreviewAudio**节点播放生成的音乐

### PSD文件处理工作流
1. 使用**导入PSD文档**节点导入现有的PSD文件
   - 点击"选择PSD文件"按钮选择文件
   - 选择是否保持原始尺寸
   - 自动解析所有图层信息
2. 使用**预览文档**节点查看导入的文档效果
3. 使用**从文档获取图层列表**节点获取所有图层
4. 使用**更新图层**节点修改特定图层属性
5. 使用**导出PSD文档**节点保存修改后的文档

### 2D动画工具工作流
1. 使用**创建空白文档**节点创建1920x1080的画布
2. 使用**LoadImage**节点加载背景图像
3. 使用**创建图层**节点创建背景图层，设置位置和混合模式
4. 使用**添加图层到文档**节点将背景图层添加到文档
5. 重复步骤2-4添加更多图层（如角色、特效等）
6. 使用**预览文档**节点查看最终合成效果
7. 可使用**从文档获取图层**和**更新图层**节点修改特定图层
8. 使用**解包图层**节点提取图层属性进行进一步处理
9. 使用**导出PSD文档**节点将最终作品保存为PSD格式

## 许可证

MIT License

## 更新日志

### v1.2.0 (2024-10-12)
- **新增功能**：
  - 添加完整的2D动画工具系统，包含图层编辑和图层工具两大分类
  - 新增10个图层编辑节点：创建空白文档、创建图层、添加图层到文档、删除图层、从文档获取图层、从文档获取图层列表、解包图层、更新图层、获取文档信息、获取图层信息
  - 新增2个图层工具节点：预览文档、预览图层
  - 支持12种混合模式：正常、正片叠底、滤色、叠加、柔光、强光、颜色减淡、颜色加深、变暗、变亮、差值、排除

- **技术改进**：
  - 优化数据存储方式，使用tensor直接存储图像数据，提高性能
  - 实现完整的图层混合系统，支持多种专业混合模式
  - 添加中英文混合模式映射，提升用户体验
  - 优化图层渲染算法，支持透明度和锚点定位

- **数据结构**：
  - 设计了完整的文档和图层数据结构
  - 支持图层ID自动分配和管理
  - 添加元数据系统，便于追踪和调试

### v1.1.0 (2025-10-03)
- **新增功能**：
  - 添加Suno音乐生成器节点，支持文本生成音乐
  - 添加音频时长控制参数，可设置10-180秒范围
  - 添加音乐标签系统，支持多个标签组合

- **改进**：
  - 优化音频格式，使用3D张量格式`[batch, channels, samples]`
  - 修复与ComfyUI官方PreviewAudio节点的兼容性问题
  - 改进API响应处理，支持t8平台的Suno API格式

- **重构**：
  - 重新组织节点分类，将所有节点迁移到AFA命名空间下
  - 将LLM/VLM节点移至`AFA/大模型`分类
  - 将配置选择器节点移至`AFA/config`分类
  - 将用户输入节点移至`AFA/输入`分类
  - 将图像编辑节点移至`AFA/图像`分类
  - 将音乐生成节点放在`AFA/音乐`分类

### v1.0.0 (2025-09-15)
- 首次发布
- 支持LLM文本生成
- 支持VLM图像分析
- 支持图像编辑
- 提供创作辅助模板

## 联系方式

如有问题或建议，请在GitHub上提交Issue或Pull Request。